# PDF2MP3 배치 변환 가이드 (v2.4)

## 🎯 개요
여러 PDF 파일을 자동으로 MP3로 변환하는 배치 처리 기능입니다.

## ✨ 주요 기능

### 1. 자동 스캔
- 지정된 폴더 내의 모든 PDF 파일 자동 검색
- 이미 변환된 파일은 자동으로 스킵
- 변환되지 않은 파일만 처리

### 2. 스마트 변환 상태 확인
다음 파일이 존재하면 "변환 완료"로 간주:
- `파일명_00.mp3`: 첫 번째 MP3 청크
- `sptxt_0.txt`: 첫 번째 텍스트 청크

### 3. 같은 폴더에 저장
- MP3 파일은 원본 PDF와 같은 폴더에 저장
- 폴더별로 작업 결과 정리 용이

## 🚀 사용 방법

### 기본 사용법

#### 배치 모드 (폴더 전체)
```bash
# 방법 1: 스크립트 사용 (권장)
./run_pdf2mp3.sh ./pdf

# 방법 2: 직접 실행
conda activate melo
python pdf2mp3.py ./pdf

# GPU 사용
./run_pdf2mp3.sh ./pdf cuda
```

#### 단일 파일 모드 (기존 방식)
```bash
# 기본
./run_pdf2mp3.sh ./pdf/document.pdf

# 특정 청크부터 시작
./run_pdf2mp3.sh ./pdf/document.pdf 10

# GPU 사용
./run_pdf2mp3.sh ./pdf/document.pdf 0 cuda
```

## 📁 폴더 구조 예시

### 변환 전
```
pdf/
├── 열세번째1.pdf
├── 열세번째2.pdf
├── 열세번째3.pdf
└── 학습자료.pdf
```

### 변환 중
```
pdf/
├── 열세번째1.pdf
├── 열세번째1_00.mp3  ✓ 완료
├── 열세번째1_01.mp3  ✓ 완료
├── sptxt_0.txt
├── sptxt_1.txt
├── 열세번째2.pdf  ← 현재 변환 중
├── 열세번째3.pdf
└── 학습자료.pdf
```

### 변환 후
```
pdf/
├── 열세번째1.pdf
├── 열세번째1_00.mp3
├── 열세번째1_01.mp3
├── 열세번째1_02.mp3
├── ...
├── 열세번째2.pdf
├── 열세번째2_00.mp3
├── 열세번째2_01.mp3
├── ...
├── 열세번째3.pdf
├── 열세번째3_00.mp3
├── ...
├── 학습자료.pdf
├── 학습자료_00.mp3
└── ...
```

## 💡 스마트 재시작 기능

### 변환 완료 파일은 자동 스킵
```bash
# 첫 실행
./run_pdf2mp3.sh ./pdf
# → 열세번째1.pdf 변환 중... 시스템 다운

# 재시작 (같은 명령)
./run_pdf2mp3.sh ./pdf
# → 열세번째1.pdf 이미 변환됨(스킵)
# → 열세번째2.pdf부터 자동 시작
```

### 실행 출력 예시
```
============================================================
📁 배치 변환 모드
============================================================
대상 디렉토리: ./pdf
언어: KR, 디바이스: cpu
============================================================

✓ 변환 대상: 3개 파일

============================================================
📄 [1/3] 열세번째1.pdf
============================================================
[1단계] PDF에서 텍스트 추출 중...
...
✅ [1/3] 완료: 열세번째1.pdf

============================================================
📄 [2/3] 열세번째2.pdf
============================================================
...
```

## 🔧 고급 사용법

### 1. 특정 PDF만 재변환
기존 MP3 파일 삭제 후 재실행:
```bash
cd pdf
rm 열세번째1_*.mp3 sptxt_*.txt
cd ..
./run_pdf2mp3.sh ./pdf
```

### 2. 로그 확인
```bash
# 실시간 로그 (다른 터미널에서)
tail -f pdf2mp3.log

# 배치 처리 진행 상황
grep "변환.*완료\|변환.*시작" pdf2mp3.log

# 실패한 파일 확인
grep "변환 실패" pdf2mp3.log
```

### 3. 여러 폴더 순차 처리
```bash
#!/bin/bash
# batch_all.sh

./run_pdf2mp3.sh ./pdf1
./run_pdf2mp3.sh ./pdf2
./run_pdf2mp3.sh ./pdf3
```

### 4. 백그라운드 실행
```bash
# 백그라운드 실행
nohup ./run_pdf2mp3.sh ./pdf > batch_convert.log 2>&1 &

# 진행 상황 확인
tail -f batch_convert.log
```

## 📊 배치 처리 결과

### 성공 시
```
============================================================
📊 배치 변환 완료
============================================================
✓ 성공: 4/4
============================================================
```

### 일부 실패 시
```
============================================================
📊 배치 변환 완료
============================================================
✓ 성공: 3/4
✗ 실패: 1/4

실패한 파일:
  - corrupt.pdf: PDF 파일에서 텍스트를 추출하지 못했습니다.
============================================================
```

## ⚠️ 주의사항

### 1. 디스크 공간 확인
```bash
# 사용 가능한 공간 확인
df -h .

# 대략적인 필요 공간
# PDF 1개 (10MB, 100페이지) → MP3 약 50-100MB
```

### 2. 메모리 부족 시
- 파일 수가 많으면 일부씩 나눠서 처리
- 또는 배치 크기를 제한하는 스크립트 작성

### 3. 중단 후 재시작
- 변환 완료된 파일은 자동 스킵
- 중단된 파일은 처음부터 다시 시작
- 부분 변환 파일(예: `_00.mp3`만 있음)은 변환 완료로 간주됨

### 4. 파일명 주의
- 공백, 특수문자가 있는 파일명도 처리 가능
- 하지만 파일명은 영문/숫자/한글 권장

## 🔍 문제 해결

### 문제 1: 변환 안 되는 파일
```bash
# 변환 상태 확인
ls -lh pdf/*.pdf
ls -lh pdf/*_00.mp3

# 수동 변환 (디버깅)
python pdf2mp3.py pdf/문제파일.pdf
```

### 문제 2: 특정 파일에서 멈춤
```bash
# 로그 확인
grep "문제파일.pdf" pdf2mp3.log

# 해당 파일 스킵하고 계속
cd pdf
touch 문제파일_00.mp3  # 더미 파일 생성
cd ..
./run_pdf2mp3.sh ./pdf  # 다음 파일부터 계속
```

### 문제 3: 디스크 공간 부족
```bash
# 변환 완료된 청크 텍스트 파일 삭제
cd pdf
rm sptxt_*.txt
cd ..
```

## 📋 체크리스트

### 실행 전
- [ ] 대상 폴더에 PDF 파일 있는지 확인
- [ ] 디스크 공간 충분한지 확인 (PDF 크기의 10배 이상 권장)
- [ ] Conda 환경 활성화 (`conda activate melo`)
- [ ] 로그 모니터링 준비 (`tail -f pdf2mp3.log`)

### 실행 중
- [ ] 진행 상황 주시
- [ ] 메모리 사용률 확인 (`free -h`)
- [ ] 오류 메시지 확인

### 실행 후
- [ ] 모든 PDF 변환 완료 확인
- [ ] 실패한 파일 있는지 확인
- [ ] MP3 파일 재생 테스트
- [ ] 불필요한 텍스트 청크 파일 삭제 (`sptxt_*.txt`)

## 🎓 실전 예시

### 예시 1: 강의 자료 폴더 일괄 변환
```bash
# 폴더 구조
lectures/
├── lecture01.pdf
├── lecture02.pdf
├── lecture03.pdf
└── ...

# 실행
./run_pdf2mp3.sh lectures

# 결과 확인
ls -lh lectures/*.mp3
```

### 예시 2: 여러 책 폴더 순차 변환
```bash
# 스크립트 작성: convert_all_books.sh
#!/bin/bash
for book_dir in books/book*/; do
    echo "Converting: $book_dir"
    ./run_pdf2mp3.sh "$book_dir"
    echo "Completed: $book_dir"
    echo "---"
done

# 실행
chmod +x convert_all_books.sh
./convert_all_books.sh
```

### 예시 3: 야간 배치 작업
```bash
# cron에 등록 (매일 새벽 2시)
# crontab -e
0 2 * * * cd /home/user/MeloTTS && ./run_pdf2mp3.sh /home/user/pdf_inbox >> batch_cron.log 2>&1
```

## 🆕 v2.4 신규 기능

### 배치 처리 모드
- ✅ 폴더 단위 자동 변환
- ✅ 변환 완료 파일 자동 스킵
- ✅ 실패 시 다음 파일 계속 진행
- ✅ 상세한 진행 상황 표시
- ✅ 최종 통계 리포트

### 스마트 재시작
- ✅ 중단 후 재실행 시 자동으로 이어서 진행
- ✅ 변환 상태 자동 감지
- ✅ 중복 작업 방지

### 로깅 강화
- ✅ 배치 처리 전용 로그
- ✅ 파일별 성공/실패 기록
- ✅ 상세한 오류 정보

## 명령어 요약

```bash
# 배치 변환
./run_pdf2mp3.sh ./pdf

# 단일 파일
./run_pdf2mp3.sh ./pdf/file.pdf

# GPU 사용 (배치)
./run_pdf2mp3.sh ./pdf cuda

# GPU 사용 (단일)
./run_pdf2mp3.sh ./pdf/file.pdf 0 cuda

# 백그라운드 실행
nohup ./run_pdf2mp3.sh ./pdf > batch.log 2>&1 &

# 진행 확인
tail -f batch.log
tail -f pdf2mp3.log

# 재시작 (중단된 곳부터)
./run_pdf2mp3.sh ./pdf
```

## 버전 정보
- **v2.4** (2026-02-14) - 배치 처리 기능 추가
- **v2.3** (2026-02-13) - 상세 로깅 기능
- **v2.2** (2026-02-13) - 파일 기반 청크 처리

## GitHub
https://github.com/nillili/MeloTTS

---

**Tip**: 첫 실행 시 1-2개 파일로 테스트 후 전체 배치 실행을 권장합니다!
