# 📖 PDF2MP3 사용 가이드 (v2.2 - 메모리 최적화)

## 🎯 개선 사항 (v2.2)

### **메모리 효율성 대폭 개선!**

이전에는 41개 청크를 **메모리에 모두 보관**했지만,
이제는 **파일로 저장 후 하나씩 읽어서 처리**합니다!

```
[기존 방식]
PDF → 텍스트 추출 → 41개 청크 메모리 보관 → 하나씩 MP3 변환
                     ↑ 메모리 부담!

[개선 방식]  
PDF → 텍스트 추출 → 41개 청크 파일 저장 → 메모리 해제 
                     ↓
                  파일에서 하나씩 읽기 → MP3 변환
                     ↑ 메모리 절약!
```

---

## 🚀 빠른 시작

### 1. 최신 코드 가져오기

```bash
cd ~/work/MeloTTS
git pull origin main
```

### 2. 실행

#### 방법 A: 메모리 최적화 스크립트 (권장)

```bash
./run_pdf2mp3.sh 열세번째1.pdf
```

#### 방법 B: 직접 실행

```bash
python pdf2mp3.py 열세번째1.pdf
```

---

## 📋 처리 단계 (v2.2)

실행하면 다음 5단계로 진행됩니다:

```
[1단계] PDF에서 텍스트 추출 중...
✓ 텍스트 추출 완료

[2단계] 텍스트 전처리 및 분할 중...
✓ 총 41개의 청크로 분할되었습니다.

[3단계] 모든 청크를 파일로 저장 중...
✓ 41개의 텍스트 파일 저장 완료
✓ 메모리에서 텍스트 데이터 해제 완료  ← 메모리 해제!

[4단계] TTS 모델 로딩 중...
TTS 모델 로딩 완료!

[5단계] MP3 파일 생성 시작 (시작 번호: 0)
============================================================

▶ 처리 중: [1/41] 청크
  - 음성 변환 중...
  ✓ 완료: 열세번째1_00.mp3

▶ 처리 중: [2/41] 청크
  - 음성 변환 중...
  ✓ 완료: 열세번째1_01.mp3

...

============================================================
✓ 모든 MP3 파일 생성 완료!

[최종] 모든 작업이 완료되었습니다.
```

---

## 🔧 중단 후 이어서 실행

중간에 오류가 발생하면, 특정 번호부터 다시 시작할 수 있습니다:

```bash
# 5번 청크부터 다시 시작 (0부터 시작이므로 6번째 청크)
python pdf2mp3.py 열세번째1.pdf 5

# 또는 스크립트로
./run_pdf2mp3.sh 열세번째1.pdf 5
```

**장점**: 이미 저장된 `sptxt_*.txt` 파일을 재사용하므로,
PDF 추출과 분할 단계를 건너뛰고 바로 MP3 변환부터 시작합니다!

---

## 📂 생성되는 파일

실행 후 다음 파일들이 생성됩니다:

### 1. 텍스트 파일 (중간 파일)
```
sptxt_0.txt   ← 첫 번째 청크
sptxt_1.txt   ← 두 번째 청크
sptxt_2.txt
...
sptxt_40.txt  ← 마지막 청크 (41개 중)
```

### 2. MP3 파일 (최종 결과물)
```
열세번째1_00.mp3
열세번째1_01.mp3
열세번째1_02.mp3
...
열세번째1_40.mp3
```

**참고**: `sptxt_*.txt` 파일은 MP3 생성 후 삭제해도 됩니다.
(다시 실행할 계획이라면 보관 권장)

---

## 💡 메모리 사용량 비교

| 버전 | 41개 청크 처리 시 메모리 사용 |
|------|------------------------------|
| **v1.0** (최초) | 1.2 GB 이상 (OOM 발생!) |
| **v2.0** (싱글톤) | ~900 MB (개선) |
| **v2.1** (강제 정리) | ~700 MB (개선) |
| **v2.2** (파일 기반) | **~500 MB** ✨ **(대폭 개선!)** |

---

## ⚠️ 여전히 "죽었음" 오류 발생 시

### 해결 방법 1: Swap 메모리 추가

```bash
# 현재 메모리 확인
free -h

# Swap이 0이면 추가 (512MB)
sudo fallocate -l 512M /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 확인
free -h
```

### 해결 방법 2: 청크 크기 더 줄이기

`pdf2mp3.py` 파일 수정:

```python
# 210번 줄 근처
def split_text(text, max_length=2000, ...):

# 다음으로 변경
def split_text(text, max_length=1500, ...):  # 또는 1000
```

### 해결 방법 3: 불필요한 프로세스 종료

```bash
# 메모리 사용 확인
top

# q 키로 종료
# 다른 프로그램을 종료하고 재시도
```

---

## 🎓 고급 옵션

### GPU 사용 (CUDA 지원 시)

```bash
python pdf2mp3.py document.pdf 0 cuda
```

### 특정 언어 지정 (기본: 한국어)

코드 수정이 필요합니다. `pdf2mp3.py` 마지막 부분 참조.

---

## 📊 성능 팁

1. **파일 기반 처리**: 대용량 PDF도 안정적으로 처리 가능
2. **중단 후 재개**: 언제든지 중단했던 지점부터 다시 시작
3. **텍스트 파일 재사용**: 같은 PDF를 여러 번 변환할 때 유리
4. **메모리 정리**: 각 청크 처리 후 자동으로 메모리 정리

---

## 🐛 문제 해결

### Q1: "sptxt_X.txt 파일을 찾을 수 없습니다" 오류

**원인**: 3단계(파일 저장)가 완료되지 않았거나 파일이 삭제됨

**해결**: 처음부터 다시 실행
```bash
python pdf2mp3.py 열세번째1.pdf 0
```

### Q2: 여전히 첫 번째 청크에서 "죽었음" 발생

**원인**: BERT 모델 로딩 시 메모리 부족

**해결**: 
1. `run_pdf2mp3.sh` 스크립트 사용 (환경 변수 최적화)
2. Swap 메모리 추가
3. 청크 크기 축소 (max_length 감소)

### Q3: 생성된 MP3 파일이 재생되지 않음

**원인**: 변환 중 오류 발생

**해결**: 
1. 해당 청크의 `sptxt_X.txt` 파일 내용 확인
2. 특수 문자나 이상한 텍스트가 있으면 수동 수정
3. 해당 청크만 다시 변환

---

## 📚 관련 문서

- **URGENT_FIX.md** - 긴급 수정 사항 및 빠른 해결책
- **MEMORY_OPTIMIZATION.md** - 상세한 메모리 최적화 문서
- **README.md** - MeloTTS 프로젝트 전체 정보

---

## ✨ 버전 히스토리

| 버전 | 날짜 | 주요 변경사항 |
|------|------|--------------|
| v1.0 | - | 초기 버전 (메모리 누수 문제) |
| v2.0 | 2026-02-13 | 싱글톤 패턴 + 메모리 관리 |
| v2.1 | 2026-02-13 | 청크 축소 + 강제 메모리 정리 |
| **v2.2** | **2026-02-13** | **파일 기반 처리 (메모리 대폭 절약)** ✨ |

---

**이제 안정적으로 대용량 PDF를 처리할 수 있습니다!** 🎉

```bash
./run_pdf2mp3.sh 열세번째1.pdf
```
